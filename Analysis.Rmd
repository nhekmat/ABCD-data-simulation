---
title: "ABCD Simulations for Manuscript"
author: "Kyle Baacke and Michael Nima Hekmat"
output:
  html_document: default
  pdf_document: default
date: "2025-08-13"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(psych)
library(agricolae)
library(lme4)
library(tidyverse)
library(ggplot2)
library(broom)
library(dplyr)
library(dotwhisker)
library(effectsize)
library(pwr)
# library(ggpubr)
# library(apaTables)
```

```{r}
abcd= read.csv("data/simulated_data_with_family.csv")
```


```{r kyle_custom_function1, include=FALSE}
# kyle custom function 1
descriptives = function(df, vars, titles){
  ind = 1
  out = data.frame(
    mean=numeric(0),
    SD=numeric(0),
    SS=numeric(0),
    Var=numeric(0),
    Skewness=numeric(0),
    kurtosis=numeric(0),
    std_error=numeric(0),
    N=numeric(0)
  )
  for (v in vars){
    print(v)
    var = df[v]
    row_vector = c(
      mean(var[!is.na(var)]),
      sd(var[!is.na(var)]),
      sum((mean(var[!is.na(var)])-var[!is.na(var)])^2),
      var(var[!is.na(var)]),
      agricolae::skewness(var[!is.na(var)]),
      agricolae::kurtosis(var[!is.na(var)]),
      sd(var[!is.na(var)])/sqrt(length(!is.na(var))),
      length(var[!is.na(var)])
    )
    print(row_vector)
    out[ind,] = row_vector
    ind = ind+1
  }
  row.names(out) = titles
  print(format(out,scientific=F, digits=3))
  return(out)
}
```

```{r testing, include=FALSE}
# vars <- c("mh_p_cbcl__synd__ext_sum", 
#           "le_l_adi_addr1_national_prcnt", 
#           "sdev_y_ders_total") #First select your relevant covariates
# titles<- c("Externalizing", "ADI", "DERS") #Give covariates nicer titles
# desc_table <- descriptives(abcd, vars, titles) #Generates description fucntion details
# desc_table
```


```{r kyle_custom_function2, include=FALSE}
#https://www.statisticshowto.com/cohens-f-statistic-definition-formulas/
# Power: https://www.r-bloggers.com/2021/05/power-analysis-in-statistics-with-r/
#    pwr.f2.test {pwr}
summary_dfs = list()
detail_dfs = list()
lm_summary_dataframe = function(label_col_1, label_col_2, label_col_3, label_col_4, lm_object){
  # label_col_2, label_col_3, terms, Adjusted_R_Squared, F, df_1, df_2, p_value, residual_SE, n_terms
  summary_obj = summary(lm_object)
  res_data_frame = data.frame(
    label_col_1 = c(label_col_1),
    label_col_2 = c(label_col_2),
    label_col_3 = c(label_col_3),
    label_col_4 = c(label_col_4),
    terms = c(toString(lm_object$terms)),
    adjusted_r_squared = c(summary_obj$adj.r.squared),
    f = c(summary_obj$fstatistic['value']), 
    df_1 = c(summary_obj$fstatistic['numdf']), 
    df_2 = c(summary_obj$fstatistic['dendf']), 
    p_value = c(pf(
      summary_obj$fstatistic['value'],
      summary_obj$fstatistic['numdf'],
      summary_obj$fstatistic['dendf'],
      lower.tail=F
      )),
    # residual_SE = c(), # TODO
    n_terms = c(length(names(lm_object$model))-1) 
  )
  return(res_data_frame)
}

lm_detail_dataframe = function(label_col_1, label_col_2, label_col_3, label_col_4, lm_object){
  # subject_subset, variable_subset, variable_name, Estimate, Std_Error, t_value, p_value, VIF, beta, partial_eta_squared
  coef_df = as.data.frame(summary(lm_object)$coefficients)
  # coef_df = coef_df[c(2:length(rownames(coef_df))),]
  coef_df$variable_name = rownames(coef_df)
  tryCatch(
    {
      coef_df$VIF = c(c(NA),vif(lm_object))
    },
    error=function(e){
      # print(e)
      coef_df$VIF = c(NA)
    }
  )
  tryCatch(
    {
      coef_df$Cohens_f2_partial_vec = c(NA,cohens_f_squared(lm_object)$Cohens_f2_partial)
      coef_df$Eta2_partial_vec = c(NA,eta_squared(lm_object)$Eta2_partial)
      coef_df$r2_partial_vec = c(NA,r2_semipartial(lm_object)$r2_semipartial)
    },
    error=function(e){
      coef_df$Cohens_f2_partial_vec = NA
      coef_df$Eta2_partial_vec = NA
      coef_df$r2_partial_vec = NA
    }
  )
  
  power_vec = c()
  summary_obj = summary(lm_object)
  for (f_val in coef_df$Cohens_f2_partial_vec){
    print(f_val)
    tryCatch(
      {
        power = pwr.f2.test(u=summary_obj$df[1]-1, v=summary_obj$df[2], f2=f_val, sig.level=0.05)$power
      },
      error=function(e){
        power = c(NA)
      }
    )
    power_vec = c(power_vec, power)
  }
  coef_df$power = unlist(power_vec, use.names = FALSE)
  coef_df$label_col_1 = label_col_1
  coef_df$label_col_2 = label_col_2
  coef_df$label_col_3 = label_col_3
  coef_df$label_col_4 = label_col_4
  return(coef_df)
}
```


### Model 1 observing effects of covariates without heat as a moderator

```{r lm_model_1, include=FALSE}
model_1 <- lm(mh_p_cbcl__synd__ext_sum ~ le_l_adi_addr1_national_prcnt + 
     sdev_y_ders_total +
     mh_y_upps_pers_sum+
     sex+
     Days_Above_90+
     le_l_coi_addr1_coi_total_national_score+
     le_l_svi_addr1_total_prcntile+
     mh_y_upps_nurg_sum, data = abcd)
```


```{r lm_summary_dataframe, include=FALSE}
summary_df <- lm_summary_dataframe(
  label_col_1 = "Model_1",
  label_col_2 = "NoHeatModerator",
  label_col_3 = "MainEffects",
  label_col_4 = "Externalizing",
  lm_object = model_1
)
summary_df
```

```{r summary_model_1}
summary(model_1)
```

# Dot Whisker Plot of Coefficients for Model 1 (No Moderator)

```{r dwplot1}
dwplot(model_1,
       dot_args = list(color = "blue", size = 2.5),
       whisker_args = list(color="blue",size = 1)) %>%
  relabel_predictors(c(
    "(Intercept)" = "Intercept",
    "le_l_adi_addr1_national_prcnt" = "Area Deprivation Index (%)",
    "sdev_y_ders_total" = "DERS Total Score", 
    "mh_y_upps_pers_sum" = "UPPS-P Perseverance",
    "sex" = "Sex",
    "Days_Above_90" = "Days Above 90°F",
    "le_l_coi_addr1_coi_total_national_score" = "COI Total Score",
    "le_l_svi_addr1_total_prcntile" = "SVI Percentile",
    "mh_y_upps_nurg_sum" = "UPPS-P Negative Urgency"
  )) +
  geom_vline(xintercept = 0, colour = "red", linetype = 2, linewidth = 1) +
  ggtitle(str_wrap("Dot Whisker Plot of Coefficients for Model 1 (No Moderator)", width =35)) +
  xlab("Coefficient Estimates") +
  ylab("Covariates") +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```

## Model 1 Post-hoc and effects size (no moderator)

```{r posthoc}
# Eta squared
eta_squared(model_1, partial = TRUE)

# Standardized betas
standardize_parameters(model_1)
```

### Model 2 observing effects of covariates with heat as a moderator

```{r model2, include=FALSE}
model_2 <- lm(mh_p_cbcl__synd__ext_sum ~ le_l_adi_addr1_national_prcnt*Days_Above_90 + 
     sdev_y_ders_total *Days_Above_90 +
     mh_y_upps_pers_sum*Days_Above_90 +
     sex*Days_Above_90+
     le_l_coi_addr1_coi_total_national_score*Days_Above_90 +
     le_l_svi_addr1_total_prcntile*Days_Above_90 +
     mh_y_upps_nurg_sum*Days_Above_90 , data = abcd)
```

```{r summary}
summary(model_2)
```

```{r dwplot2}
interaction <- tidy(model_2) %>% filter(str_detect(term, ":"))
dwplot(interaction,
       dot_args = list(color = "blue", size = 3),
       whisker_args = list(color = "blue", size = 1.5)) %>%
  relabel_predictors(c(
    "le_l_adi_addr1_national_prcnt:Days_Above_90" = "ADI × Heat",
    "Days_Above_90:sdev_y_ders_total" = "DERS × Heat", 
    "Days_Above_90:mh_y_upps_pers_sum" = "Perseverance × Heat",
    "Days_Above_90:sex" = "Sex × Heat",
    "Days_Above_90:le_l_coi_addr1_coi_total_national_score" = "COI × Heat",
    "Days_Above_90:le_l_svi_addr1_total_prcntile" = "SVI × Heat",
    "Days_Above_90:mh_y_upps_nurg_sum" = "Negative Urgency × Heat"
  )) +
  geom_vline(xintercept = 0, colour = "red", linetype = 2, linewidth = 1) +
  ggtitle(str_wrap("Dot Whisker Plot of Coefficients for Model 2 (With Moderator)", width = 35)) +
  xlab("Coefficient Estimates") +
  ylab("Covariates") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

## Model 2 Post-hoc and effects size for moderation effects of heat

```{r posthoc2}
# eta squared
eta_squared(model_2, partial = TRUE)
# standardized betas
standardize_parameters(model_2) 
```

## Finally... The differences in $R^2$...

```{r r2table}
#R2
r2model1 = summary(model_1)$r.squared
r2model2 = summary(model_2)$r.squared

# adj R2
r2adjmodel1 = summary(model_1)$adj.r.squared
r2adjmodel2 = summary(model_2)$adj.r.squared

# data frame for comparison
df = data.frame(
  Models = c("Residual Squared for model 1", "Residual squared for model 2"),
  R2 = c(r2model1, r2model2),
  AdjustedR2= c(r2adjmodel1, r2adjmodel2)
)
print(df)
```

```{r testing lmer}
# Testing for each site
# Parsing data
# california <- abcd %>% filter(site_id==5)
# head(california)
# 
# lme_test <- lmer(mh_p_cbcl__synd__ext_sum ~ le_l_adi_addr1_national_prcnt + 
#      sdev_y_ders_total +
#      mh_y_upps_pers_sum+
#      sex+
#      Days_Above_90+
#      le_l_coi_addr1_coi_total_national_score+
#      le_l_svi_addr1_total_prcntile+
#      mh_y_upps_nurg_sum, 
#      data = california)
# 
# summary(lme_test)

```

## Conclusions...

-   **The model has low adjusted** $R^2$, with the moderator it increases a bit (still pretty low).
-   **With moderation effects, Social Vulnerability Index is the only significant covariate.**
-   **It may be interesting to see how this changes state by state since this model looks at things nationally.**




