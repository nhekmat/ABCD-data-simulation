---
title: "ABCD Simulations for Manuscript"
author: "Kyle Baacke and Michael Nima Hekmat"
output:
  html_document: default
  pdf_document: default
date: "2025-08-13"
editor_options:
  chunk_output_type: inline
---
# Setup

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(psych)
library(agricolae)
library(lme4)
library(tidyverse)
library(ggplot2)
library(broom)
library(dplyr)
library(dotwhisker)
library(effectsize)
library(pwr)
library(arrow)
# library(ggpubr)
# library(apaTables)
```

## Read Data
```{r}
# abcd= readRDS('C:/Users/kbaacke/ABCD_6.0/HeatProject_01/dataset.rds')
# abcd = read_parquet('C:/Users/kbaacke/ABCD_6.0/HeatProject_01/dataset.parquet')
abcd = read.csv('C:/Users/kbaacke/ABCD_6.0/HeatProject_01/dataset.csv')
abcd = as.data.frame(abcd)
abcd$site_char = as.character(abcd$ab_g_dyn__design_site)

```

## Custom Functions
```{r kyle_custom_function1, include=FALSE}
# kyle custom function 1
descriptives = function(df, vars, titles){
  ind = 1
  out = data.frame(
    mean=numeric(0),
    SD=numeric(0),
    SS=numeric(0),
    Var=numeric(0),
    Skewness=numeric(0),
    kurtosis=numeric(0),
    std_error=numeric(0),
    N=numeric(0)
  )
  for (v in vars){
    print(v)
    var = df[v]
    row_vector = c(
      mean(var[!is.na(var)]),
      sd(var[!is.na(var)]),
      sum((mean(var[!is.na(var)])-var[!is.na(var)])^2),
      var(var[!is.na(var)]),
      agricolae::skewness(var[!is.na(var)]),
      agricolae::kurtosis(var[!is.na(var)]),
      sd(var[!is.na(var)])/sqrt(length(!is.na(var))),
      length(var[!is.na(var)])
    )
    print(row_vector)
    out[ind,] = row_vector
    ind = ind+1
  }
  row.names(out) = titles
  print(format(out,scientific=F, digits=3))
  return(out)
}
```


```{r testing, include=FALSE}
# vars <- c("mh_p_cbcl__synd__ext_sum", 
#           "le_l_adi_addr1_national_prcnt", 
#           "sdev_y_ders_total") #First select your relevant covariates
# titles<- c("Externalizing", "ADI", "DERS") #Give covariates nicer titles
# desc_table <- descriptives(abcd, vars, titles) #Generates description fucntion details
# desc_table
```


```{r kyle_custom_function2, include=FALSE}
#https://www.statisticshowto.com/cohens-f-statistic-definition-formulas/
# Power: https://www.r-bloggers.com/2021/05/power-analysis-in-statistics-with-r/
#    pwr.f2.test {pwr}
summary_dfs = list()
detail_dfs = list()
lm_summary_dataframe = function(label_col_1, label_col_2, label_col_3, label_col_4, lm_object){
  # label_col_2, label_col_3, terms, Adjusted_R_Squared, F, df_1, df_2, p_value, residual_SE, n_terms
  summary_obj = summary(lm_object)
  res_data_frame = data.frame(
    label_col_1 = c(label_col_1),
    label_col_2 = c(label_col_2),
    label_col_3 = c(label_col_3),
    label_col_4 = c(label_col_4),
    terms = c(toString(lm_object$terms)),
    adjusted_r_squared = c(summary_obj$adj.r.squared),
    f = c(summary_obj$fstatistic['value']), 
    df_1 = c(summary_obj$fstatistic['numdf']), 
    df_2 = c(summary_obj$fstatistic['dendf']), 
    p_value = c(pf(
      summary_obj$fstatistic['value'],
      summary_obj$fstatistic['numdf'],
      summary_obj$fstatistic['dendf'],
      lower.tail=F
      )),
    # residual_SE = c(), # TODO
    n_terms = c(length(names(lm_object$model))-1) 
  )
  return(res_data_frame)
}


lm_detail_dataframe = function(label_col_1, label_col_2, label_col_3, label_col_4, lm_object){
  # subject_subset, variable_subset, variable_name, Estimate, Std_Error, t_value, p_value, VIF, beta, partial_eta_squared
  coef_df = as.data.frame(summary(lm_object)$coefficients)
  # coef_df = coef_df[c(2:length(rownames(coef_df))),]
  coef_df$variable_name = rownames(coef_df)
  tryCatch(
    {
      coef_df$VIF = c(c(NA),vif(lm_object))
    },
    error=function(e){
      # print(e)
      coef_df$VIF = c(NA)
    }
  )
  tryCatch(
    {
      coef_df$Cohens_f2_partial_vec = c(NA,cohens_f_squared(lm_object)$Cohens_f2_partial)
      coef_df$Eta2_partial_vec = c(NA,eta_squared(lm_object)$Eta2_partial)
      coef_df$r2_partial_vec = c(NA,r2_semipartial(lm_object)$r2_semipartial)
    },
    error=function(e){
      coef_df$Cohens_f2_partial_vec = NA
      coef_df$Eta2_partial_vec = NA
      coef_df$r2_partial_vec = NA
    }
  )
  
  power_vec = c()
  summary_obj = summary(lm_object)
  for (f_val in coef_df$Cohens_f2_partial_vec){
    print(f_val)
    tryCatch(
      {
        power = pwr.f2.test(u=summary_obj$df[1]-1, v=summary_obj$df[2], f2=f_val, sig.level=0.05)$power
      },
      error=function(e){
        power = c(NA)
      }
    )
    power_vec = c(power_vec, power)
  }
  coef_df$power = unlist(power_vec, use.names = FALSE)
  coef_df$label_col_1 = label_col_1
  coef_df$label_col_2 = label_col_2
  coef_df$label_col_3 = label_col_3
  coef_df$label_col_4 = label_col_4
  return(coef_df)
}
```
## Data Filtering
```{r}
# abcd_f = filter(abcd, session_id=='ses-01A')
abcd_f = abcd[
  (abcd$session_id=='ses-00A') &
  !is.na(abcd$mh_y_bisbas__bis_sum__v01),#,
  ]
```

# Estimate 90th percentiles per site



```{r}
#Site level 90th percentile
percentile_list = list()
temp_cols = grep("le_l_temp__addr1__temp_max__db", names(abcd), value=TRUE)

for (site in unique(abcd[!is.na(abcd$ab_g_dyn__design_site),c('site_char')])){
  site_df = abcd[as.character(abcd$ab_g_dyn__design_site)==site,]
  temp_list = c()
  for (col in temp_cols){
    temp_list = c(temp_list, site_df[,c(col)])
  }
  percentile_90 = quantile(temp_list, .9, na.rm=TRUE)
  percentile_list[[site]] = as.numeric(percentile_90)
}

# percentile_list
```

```{r}
#consotrium level 90th percentile
temp_list = c()
for (col in temp_cols){
  temp_list = c(temp_list, abcd_f[,c(col)])
}
percentile_90_consotrium = quantile(temp_list, .9, na.rm=TRUE)

```


 ## Variable Transformation
 
  * This for days above site percentile 9th rank and then filters


```{r}
# Checking to see which participants were exposed above 90th percentile and assigning binary number (0 or 1) for both site level and consortium level
for (d in c(0:6)){
  abcd_f[c(paste0("temp_90th_db",d))] = ifelse(abcd_f[c(paste0("le_l_temp__addr1__temp_max__db",d))]>percentile_90_consotrium, 1, 0)
  for (site in unique(abcd_f$site_char)){
    abcd_f[c(paste0("temp_90th_site_db",d))] = ifelse(abcd_f[c(paste0("le_l_temp__addr1__temp_max__db",d))]>percentile_list[[site]], 1, 0)
  }
}

#Creating column for site level temp above 90th percentile
site_temp_cols = grep("temp_90th_site_db", names(abcd_f), value=TRUE)
#Creating column for consortium level temp above 90th percentile
global_temp_cols = grep("temp_90th_db", names(abcd_f), value=TRUE)

# Summing rows to see how many days exposed above 90th percentile (days exposed to extreme heat) for site
abcd_f$days_g_90_site = rowSums(abcd_f[,site_temp_cols])

# Summing rows to see how many days exposed above 90th percentile (days exposed to extreme heat) for consortium
abcd_f$days_g_90_consotrium = rowSums(abcd_f[,global_temp_cols])

```

# Establishing target variables

```{r}
# Looking for participants with these variables
target_vars = c(
  'mh_p_cbcl__synd__ext_sum', 'le_l_adi__addr1__national_prcnt',
  'days_g_90_consotrium', 'mh_y_bisbas__bis_sum__v01', 'mh_y_upps__pers_sum', 'ab_g_stc__cohort_sex', 
  'le_l_coi__addr1__coi__total__national_score', 'le_l_svi__addr1__total_prcntile', 'mh_y_upps__nurg_sum'
  )
# Rewrite dataset
abcd_f1 = abcd_f

# Remove rows with NA values
for (v in target_vars){
  abcd_f1 = abcd_f1[!(is.na(abcd_f1[,c(v)])),]
}

# abcd_f1
```

# Data manipulation for sex and floor effect

```{r}
# Setting sex as categorical variable
abcd_f1$ab_g_stc__cohort_sex = as.factor(abcd_f1$ab_g_stc__cohort_sex)

# Removing floor effect, participants must be exposed to extreme heat
abcd_f2 = abcd_f1[abcd_f1$days_g_90_site>0,]
```


# Model Evaluation

### Model 1 observing effects of covariates without heat as a moderator

```{r lm_model_1}
# Had to drop SVI due to high MC (>3)
model_1 = lmer(
  mh_p_cbcl__synd__ext_sum ~
    le_l_adi__addr1__national_prcnt + mh_y_bisbas__bis_sum__v01 + 
    days_g_90_site + ab_g_stc__cohort_sex +
    mh_y_upps__pers_sum + mh_y_upps__nurg_sum +
    le_l_coi__addr1__coi__total__national_score + #le_l_svi__addr1__total_prcntile +
    (1|site_char) + (1|ab_g_stc__design_id__fam),
    data = abcd_f1[abcd_f1$days_g_90_site>0,]
)
summary(model_1)


anova(model_1)
coefs <- data.frame(coef(summary(model_1)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
car::vif(model_1)
<<<<<<< Updated upstream
get_gof(model_1)
=======
modelsummary::get_gof(model_1)

# Interpretation of values
# The a linear mixed effects model analyzing the relationship between externalizing symptoms and area deprivation national score, behavioral inhibition score, days exposed to extreme heat, cohort sex, UPPS perserverance score, UPPS negative urgency score, and child oppertunity index national score, UPPS subscales of Negative Urgency (beta = 0.31, SE = 0.03, t = 9.32, p < 0.001) and Perseverance (beta = 0.17, SE = 0.04, t = 4.56, p < 0.001) was positively associated with externalizing behaviors. Sex was positively associated with externalizing behaviors (beta = -1.00, SE =  0.17, t = -5.71, p < 0.001). Childhood opportunity index scores (beta =-0.01, SE = 0.01, t = -2.72, p = .006). Area deprivation index, extreme heat exposure, and BIS score were not significantly associated with externalizing behaviors.

# Multicolinearity was measured using Variance Inflation Factor (VIF). Covariates with VIF scores greater than 3 were excluded from the model. (Unsure whether I should say that we dropped SVI or if it even matters)

>>>>>>> Stashed changes
# model_1 <- lm(mh_p_cbcl__synd__ext_sum ~ le_l_adi__addr1__national_prcnt + 
#      # sdev_y_ders_total +
#      mh_y_upps_pers_sum+
#      sex+
#      Days_Above_90+
#      le_l_coi_addr1_coi_total_national_score+
#      le_l_svi_addr1_total_prcntile+
#      mh_y_upps_nurg_sum, data = abcd)
```

# Moderating effect of heat for model 1

```{r}
# Had to drop SVI due to high MC (>3)
model_1_moderating = lmer(
  mh_p_cbcl__synd__ext_sum ~
    le_l_adi__addr1__national_prcnt+ mh_y_bisbas__bis_sum__v01 + 
    days_g_90_site*ab_g_stc__cohort_sex +
    mh_y_upps__pers_sum + mh_y_upps__nurg_sum +
    le_l_coi__addr1__coi__total__national_score +# le_l_svi__addr1__total_prcntile +
    (1|site_char) + (1|ab_g_stc__design_id__fam),
    data = abcd_f1[abcd_f1$days_g_90_site>0,]
)
summary(model_1_moderating)
anova(model_1_moderating)
coefs <- data.frame(coef(summary(model_1_moderating)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
car::vif(model_1_moderating)
library(modelsummary)
library(lmerTest)
get_gof(model_1_moderating)
```


### Model 1 observing effects of covariates with heat as a moderator

```{r lm_model_1a}
# Had to drop SVI due to high MC (>3)
model_1a = lmer(
  mh_p_cbcl__synd__ext_sum ~
    days_g_90_site *
    (le_l_adi__addr1__national_prcnt + mh_y_bisbas__bis_sum__v01 + 
    ab_g_stc__cohort_sex +
    mh_y_upps__pers_sum + mh_y_upps__nurg_sum +
    le_l_coi__addr1__coi__total__national_score) +# le_l_svi__addr1__total_prcntile +
    (1|site_char) + (1|ab_g_stc__design_id__fam),
    data = abcd_f1[abcd_f1$days_g_90_site>0,]
)
summary(model_1a)
anova(model_1a)
coefs <- data.frame(coef(summary(model_1a)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
car::vif(model_1a)
```

### Model 1 observing effects of covariates with heat as a moderator for males

```{r}

# Had to drop SVI due to high MC (>3)
model_1a_male = lmer(
  mh_p_cbcl__synd__ext_sum ~
    days_g_90_site *
    # (le_l_adi__addr1__national_prcnt + mh_y_bisbas__bis_sum__v01 + 
    # # ab_g_stc__cohort_sex +
    # mh_y_upps__pers_sum + mh_y_upps__nurg_sum +
    # le_l_coi__addr1__coi__total__national_score) +# le_l_svi__addr1__total_prcntile +
    (1|site_char) + (1|ab_g_stc__design_id__fam),
    data = abcd_f1[
      (abcd_f1$days_g_90_site>0) & (abcd_f1$ab_g_stc__cohort_sex==1),
    ]
)
summary(model_1a_male)
anova(model_1a_male)
coefs <- data.frame(coef(summary(model_1a_male)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
# car::vif(model_1a_male)


```


### Model 1 observing effects of covariates with heat as a moderator for females

```{r}
# Had to drop SVI due to high MC (>3)
model_1a_female = lmer(
  mh_p_cbcl__synd__ext_sum ~
    days_g_90_site *
    # (le_l_adi__addr1__national_prcnt + mh_y_bisbas__bis_sum__v01 + 
    # # ab_g_stc__cohort_sex +
    # mh_y_upps__pers_sum + mh_y_upps__nurg_sum +
    # le_l_coi__addr1__coi__total__national_score) +# le_l_svi__addr1__total_prcntile +
    (1|site_char) + (1|ab_g_stc__design_id__fam),
    data = abcd_f1[
      (abcd_f1$days_g_90_site>0) & (abcd_f1$ab_g_stc__cohort_sex==2),
    ]
)
summary(model_1a_female)
anova(model_1a_female)
coefs <- data.frame(coef(summary(model_1a_female)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
# car::vif(model_1a_female)
```



```{r}
model_2 = lmer(
  mh_p_cbcl__synd__ext_sum ~
    le_l_adi__addr1__national_prcnt + mh_y_bisbas__bis_sum__v01 + 
    days_g_90_site + ab_g_stc__cohort_sex +
    mh_y_upps__pers_sum + mh_y_upps__nurg_sum +
    # le_l_coi__addr1__coi__total__national_score +# le_l_svi__addr1__total_prcntile + 
    (1|site_char) + (1|ab_g_stc__design_id__fam),
    data = abcd_f1
)
summary(model_2)
anova(model_2)
coefs <- data.frame(coef(summary(model_2)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
car::vif(model_2)
```

# below is old code I believe

```{r lm_summary_dataframe, include=FALSE}
summary_df <- lm_summary_dataframe(
  label_col_1 = "Model_1",
  label_col_2 = "NoHeatModerator",
  label_col_3 = "MainEffects",
  label_col_4 = "Externalizing",
  lm_object = model_1
)
summary_df
```

```{r summary_model_1}
results <- tidy(model_1)
# Doing Benjamini–Hochberg (FDR)
results$p.adjusted <- p.adjust(results$p.value, method = "BH")
results %>% mutate(
  p.value = round(p.value, 3),
  p.adjusted = round(p.adjusted, 3))
```

# Dot Whisker Plot of Coefficients for Model 1 (No Moderator)

```{r dwplot1}
dwplot(model_1,
       dot_args = list(color = "blue", size = 2.5),
       whisker_args = list(color="blue",size = 1)) %>%
  relabel_predictors(c(
    "(Intercept)" = "Intercept",
    "le_l_adi_addr1_national_prcnt" = "Area Deprivation Index (%)",
    "sdev_y_ders_total" = "DERS Total Score", 
    "mh_y_upps_pers_sum" = "UPPS-P Perseverance",
    "sex" = "Sex",
    "Days_Above_90" = "Days Above 90°F",
    "le_l_coi_addr1_coi_total_national_score" = "COI Total Score",
    "le_l_svi_addr1_total_prcntile" = "SVI Percentile",
    "mh_y_upps_nurg_sum" = "UPPS-P Negative Urgency"
  )) +
  geom_vline(xintercept = 0, colour = "red", linetype = 2, linewidth = 1) +
  ggtitle(str_wrap("Dot Whisker Plot of Coefficients for Model 1 (No Moderator)", width =35)) +
  xlab("Coefficient Estimates") +
  ylab("Covariates") +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```

## Model 1 Post-hoc and effects size (no moderator)

```{r posthoc}
# Eta squared
eta_squared(model_1, partial = TRUE)

# Standardized betas
standardize_parameters(model_1)
```

### Model 2 observing effects of covariates with heat as a moderator

```{r model2, include=FALSE}
model_2 <- lm(mh_p_cbcl__synd__ext_sum ~ le_l_adi_addr1_national_prcnt*Days_Above_90 + 
     sdev_y_ders_total *Days_Above_90 +
     mh_y_upps_pers_sum*Days_Above_90 +
     sex*Days_Above_90+
     le_l_coi_addr1_coi_total_national_score*Days_Above_90 +
     le_l_svi_addr1_total_prcntile*Days_Above_90 +
     mh_y_upps_nurg_sum*Days_Above_90 , data = abcd)
```

```{r summary}
results2<- tidy(model_2)
# Doing Benjamini–Hochberg (FDR)
results2$p.adjusted <- p.adjust(results2$p.value, method = "BH")
results2%>% mutate(
  p.value = round(p.value, 3),
  p.adjusted = round(p.adjusted, 3))


```

```{r dwplot2}
interaction <- tidy(model_2) %>% filter(str_detect(term, ":"))
dwplot(interaction,
       dot_args = list(color = "blue", size = 3),
       whisker_args = list(color = "blue", size = 1.5)) %>%
  relabel_predictors(c(
    "le_l_adi_addr1_national_prcnt:Days_Above_90" = "ADI × Heat",
    "Days_Above_90:sdev_y_ders_total" = "DERS × Heat", 
    "Days_Above_90:mh_y_upps_pers_sum" = "Perseverance × Heat",
    "Days_Above_90:sex" = "Sex × Heat",
    "Days_Above_90:le_l_coi_addr1_coi_total_national_score" = "COI × Heat",
    "Days_Above_90:le_l_svi_addr1_total_prcntile" = "SVI × Heat",
    "Days_Above_90:mh_y_upps_nurg_sum" = "Negative Urgency × Heat"
  )) +
  geom_vline(xintercept = 0, colour = "red", linetype = 2, linewidth = 1) +
  ggtitle(str_wrap("Dot Whisker Plot of Coefficients for Model 2 (With Moderator)", width = 35)) +
  xlab("Coefficient Estimates") +
  ylab("Covariates") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

## Model 2 Post-hoc and effects size for moderation effects of heat

```{r posthoc2}
# eta squared
eta_squared(model_2, partial = TRUE)
# standardized betas
standardize_parameters(model_2) 
```

## Finally... The differences in $R^2$...

```{r r2table}
#R2
r2model1 = summary(model_1)$r.squared
r2model2 = summary(model_2)$r.squared

# adj R2
r2adjmodel1 = summary(model_1)$adj.r.squared
r2adjmodel2 = summary(model_2)$adj.r.squared

# data frame for comparison
df = data.frame(
  Models = c("Residual Squared for model 1", "Residual squared for model 2"),
  R2 = c(r2model1, r2model2),
  AdjustedR2= c(r2adjmodel1, r2adjmodel2)
)
print(df)
```

```{r testing lmer}
# Testing for each site
# Parsing data
# california <- abcd %>% filter(site_id==5)
# head(california)
# 
# lme_test <- lmer(mh_p_cbcl__synd__ext_sum ~ le_l_adi_addr1_national_prcnt + 
#      sdev_y_ders_total +
#      mh_y_upps_pers_sum+
#      sex+
#      Days_Above_90+
#      le_l_coi_addr1_coi_total_national_score+
#      le_l_svi_addr1_total_prcntile+
#      mh_y_upps_nurg_sum, 
#      data = california)
# 
# summary(lme_test)

```

## Conclusions...

-   **The model has low adjusted** $R^2$, with the moderator it increases a bit (still pretty low).
-   **With moderation effects, Social Vulnerability Index is the only significant covariate.**
-   **It may be interesting to see how this changes state by state since this model looks at things nationally.**




